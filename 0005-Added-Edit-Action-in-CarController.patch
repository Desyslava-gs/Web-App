From c185db38ebba1dda4db13151cfca8c3f1ed8945c Mon Sep 17 00:00:00 2001
From: Desyslava-gs <84912601+Desyslava-gs@users.noreply.github.com>
Date: Mon, 19 Jul 2021 02:17:02 +0300
Subject: [PATCH 5/8] Added Edit Action in CarController

---
 .../WebApp/Controllers/CarsController.cs      | 78 ++++++++++++++++---
 WebAppDEMO/WebApp/Data/CarRepairDbContext.cs  |  3 +
 .../WebApp/Models/Cars/CreateCarFormModel.cs  |  7 +-
 WebAppDEMO/WebApp/Startup.cs                  | 24 +++---
 WebAppDEMO/WebApp/Views/Cars/Details.cshtml   | 19 ++---
 WebAppDEMO/WebApp/Views/Cars/Edit.cshtml      | 40 ++++------
 WebAppDEMO/WebApp/WebApp.csproj               |  7 +-
 7 files changed, 114 insertions(+), 64 deletions(-)

diff --git a/WebAppDEMO/WebApp/Controllers/CarsController.cs b/WebAppDEMO/WebApp/Controllers/CarsController.cs
index 65ca2e7..577e131 100644
--- a/WebAppDEMO/WebApp/Controllers/CarsController.cs
+++ b/WebAppDEMO/WebApp/Controllers/CarsController.cs
@@ -1,5 +1,6 @@
 ï»¿using System;
 using System.Collections.Generic;
+using System.IO;
 using System.Linq;
 using System.Threading.Tasks;
 using Microsoft.AspNetCore.Mvc;
@@ -42,24 +43,25 @@ namespace WebApp.Controllers
                 .Where(m => m.Id == id)
                 .Select(c => new DetailsCarViewModel
                 {
+                    Id = c.Id,
                     PictureUrl = c.PictureUrl,
                     Make = c.Make,
                     Model = c.Model,
                     Color = c.Color,
                     Description = c.Description,
-                    Year = c.Year, 
-                    FuelType = c.FuelType.Name ,//c.FuelTypeId,
+                    Year = c.Year,
+                    FuelType = c.FuelType.Name,//c.FuelTypeId,
                     PlateNumber = c.PlateNumber,
                     VinNumber = c.VinNumber,
 
                 }).ToList()
                 .FirstOrDefault();
-             //  car.FuelType = this.GetFuelType();
+             
             if (car == null)
             {
                 return NotFound();
             }
-
+  //car.FuelType = this.GetFuelType().ToString();
 
             return View(car);
         }
@@ -77,6 +79,11 @@ namespace WebApp.Controllers
         [ValidateAntiForgeryToken]
         public IActionResult Create(CreateCarFormModel car)
         {
+            if (!this.data.FuelTypes.Any(c=>c.Id==car.FuelTypeId))
+            {
+                this.ModelState.AddModelError(nameof(car.FuelTypeId), "FuelType does not exist.");
+            }
+
             if (!ModelState.IsValid)
             {
                 car.FuelTypes = this.GetFuelType();
@@ -85,6 +92,7 @@ namespace WebApp.Controllers
 
             var carData = new Car
             {
+                Id = car.Id,
                 Make = car.Make,
                 Model = car.Model,
                 Color = car.Color,
@@ -117,19 +125,33 @@ namespace WebApp.Controllers
 
         }
         // GET: Cars1/Edit/5
-        public async Task<IActionResult> Edit(string id)
+        public IActionResult Edit(string id)
         {
             if (id == null)
             {
                 return NotFound();
             }
 
-            var car = await data.Cars.FindAsync(id);
+            var car =  data.Cars.Find(id);
+           
             if (car == null)
             {
                 return NotFound();
-            }
-            return View(car);
+            } 
+            return View(new EditCarFormModel
+            {
+                FuelTypes = this.GetFuelType(),
+                Id = car.Id,
+                Make = car.Make,
+                Model = car.Model,
+                Color = car.Color,
+                Description = car.Description,
+                FuelTypeId = car.FuelTypeId,
+                PictureUrl = car.PictureUrl,
+                PlateNumber = car.PlateNumber,
+                VinNumber = car.VinNumber,
+                Year = car.Year,
+            });
         }
 
         // POST: Cars1/Edit/5
@@ -137,7 +159,7 @@ namespace WebApp.Controllers
         // For more details, see http://go.microsoft.com/fwlink/?LinkId=317598.
         [HttpPost]
         [ValidateAntiForgeryToken]
-        public async Task<IActionResult> Edit(string id, [Bind("Id,Make,Model,Year,Color,PlateNumber,Fuel,VinNumber,PictureUrl,Description")] Car car)
+        public IActionResult Edit(string id, EditCarFormModel car)
         {
             if (id != car.Id)
             {
@@ -148,8 +170,22 @@ namespace WebApp.Controllers
             {
                 try
                 {
-                    data.Update(car);
-                    await data.SaveChangesAsync();
+                    var carData = new Car
+                    {
+                        Id = car.Id,
+                        Make = car.Make,
+                        Model = car.Model,
+                        Color = car.Color,
+                        Description = car.Description,
+                        FuelTypeId = car.FuelTypeId,
+                        PictureUrl = car.PictureUrl,
+                        PlateNumber = car.PlateNumber,
+                        VinNumber = car.VinNumber,
+                        Year = car.Year,
+                    };
+                   
+                    this.data.Update(carData);
+                    this.data.SaveChanges();
                 }
                 catch (DbUpdateConcurrencyException)
                 {
@@ -162,7 +198,7 @@ namespace WebApp.Controllers
                         throw;
                     }
                 }
-                return RedirectToAction(nameof(Index));
+                return RedirectToAction("Index");
             }
             return View(car);
         }
@@ -200,5 +236,23 @@ namespace WebApp.Controllers
         {
             return data.Cars.Any(e => e.Id == id);
         }
+
+        //private string ProcessUploadedFile(SpeakerViewModel model)
+        //{
+        //    string uniqueFileName = null;
+
+        //    if (model.SpeakerPicture != null)
+        //    {
+        //        string uploadsFolder = Path.Combine(webHostEnvironment.WebRootPath, "Uploads");
+        //        uniqueFileName = Guid.NewGuid().ToString() + "_" + model.SpeakerPicture.FileName;
+        //        string filePath = Path.Combine(uploadsFolder, uniqueFileName);
+        //        using (var fileStream = new FileStream(filePath, FileMode.Create))
+        //        {
+        //            model.SpeakerPicture.CopyTo(fileStream);
+        //        }
+        //    }
+
+        //    return uniqueFileName;
+        //}
     }
 }
diff --git a/WebAppDEMO/WebApp/Data/CarRepairDbContext.cs b/WebAppDEMO/WebApp/Data/CarRepairDbContext.cs
index 683ff56..8947c84 100644
--- a/WebAppDEMO/WebApp/Data/CarRepairDbContext.cs
+++ b/WebAppDEMO/WebApp/Data/CarRepairDbContext.cs
@@ -4,6 +4,7 @@ using System.Text;
 using Microsoft.AspNetCore.Identity.EntityFrameworkCore;
 using Microsoft.EntityFrameworkCore;
 using WebApp.Data.Models;
+using WebApp.Models.Cars;
 
 namespace WebApp.Data
 {
@@ -34,5 +35,7 @@ namespace WebApp.Data
 
             base.OnModelCreating(builder);
         }
+
+        public DbSet<WebApp.Models.Cars.EditCarFormModel> EditCarFormModel { get; set; }
     }
 }
diff --git a/WebAppDEMO/WebApp/Models/Cars/CreateCarFormModel.cs b/WebAppDEMO/WebApp/Models/Cars/CreateCarFormModel.cs
index 2dc2078..ae39559 100644
--- a/WebAppDEMO/WebApp/Models/Cars/CreateCarFormModel.cs
+++ b/WebAppDEMO/WebApp/Models/Cars/CreateCarFormModel.cs
@@ -10,10 +10,9 @@ namespace WebApp.Models.Cars
 {
     public class CreateCarFormModel
     {
-        //[Key]
-        //[Required]
-        //public string Id { get; set; }
-
+        [Key]
+        [Required]
+        public string Id { get; set; }
 
         [Required]
         [StringLength(CarMakeMaxLength, MinimumLength = CarMakeMinLength)]
diff --git a/WebAppDEMO/WebApp/Startup.cs b/WebAppDEMO/WebApp/Startup.cs
index 5176dd4..2dabe46 100644
--- a/WebAppDEMO/WebApp/Startup.cs
+++ b/WebAppDEMO/WebApp/Startup.cs
@@ -82,21 +82,21 @@ namespace WebApp
                 endpoints.MapDefaultControllerRoute();
                 endpoints.MapRazorPages();
 
-                endpoints.MapControllerRoute(
-                    name: "services",
-                    pattern: "{controller=Services}/{action=Services}");
-                endpoints.MapControllerRoute(
-                    name: "contacts",
-                    pattern: "{controller=Contacts}/{action=Contacts}");
+                //endpoints.MapControllerRoute(
+                //    name: "services",
+                //    pattern: "{controller=Services}/{action=Services}");
+                //endpoints.MapControllerRoute(
+                //    name: "contacts",
+                //    pattern: "{controller=Contacts}/{action=Contacts}");
 
-                endpoints.MapControllerRoute(
-                    name: "cars",
-                    pattern: "{controller=Cars}/{action=Cars}");
+                //endpoints.MapControllerRoute(
+                //    name: "cars",
+                //    pattern: "{controller=Cars}/{action=Cars}");
 
                 
-                endpoints.MapControllerRoute(
-                    name: "cars",
-                    pattern:"{controller=Cars}/{action=Details}/{id?}");
+                //endpoints.MapControllerRoute(
+                //    name: "cars",
+                //    pattern:"{controller=Cars}/{action=Details}/{id?}");
 
 
 
diff --git a/WebAppDEMO/WebApp/Views/Cars/Details.cshtml b/WebAppDEMO/WebApp/Views/Cars/Details.cshtml
index 5b51659..982b8b0 100644
--- a/WebAppDEMO/WebApp/Views/Cars/Details.cshtml
+++ b/WebAppDEMO/WebApp/Views/Cars/Details.cshtml
@@ -27,8 +27,8 @@
         <dd class="col-sm-9">
             @Model.PlateNumber
         </dd>
-        <dt  class="col-sm-3">
-          <label asp-for="@Model.Year"></label>
+        <dt class="col-sm-3">
+            <label asp-for="@Model.Year"></label>
         </dt>
         <dd class="col-sm-9">
             @Model.Year
@@ -39,7 +39,7 @@
         <dd class="col-sm-9">
             @Model.Color
         </dd>
-       
+
         <dt class="col-sm-3">
             <label asp-for="@Model.FuelType"></label>
         </dt>
@@ -60,16 +60,17 @@
 
     </dl>
 </div>
-    <div class="text-center overflow-hidden">
-        <a class="btn btn-warning" asp-action="Edit" asp-route-id="@Model.Id">Edit</a>
-        <a class="btn btn-danger" asp-action="Delete" asp-route-id="@Model.Id">Delete</a>
-        <a class="btn btn-info" asp-action="Repairs" asp-route-id="@Model.Id">Repairs</a>
-    </div>
+<div class="text-center overflow-hidden">
+    <a class="btn btn-warning" asp-action="Edit" asp-route-id="@Model.Id">Edit</a>
+    <a class="btn btn-danger" asp-action="Delete" asp-route-id="@Model.Id">Delete</a>
+    <a class="btn btn-info" asp-controller="Repairs" asp-action="Index" asp-route-id="@Model.Id">Repairs</a>
+</div>
 
 
-<div class="container"style="margin-top:3%; margin-bottom: 2%;">
+<div class="container" style="margin-top:3%; margin-bottom: 2%;">
     <a class="float-right" asp-action="Index">Back to List</a>
 </div>
 
 
 
+Â© 2021 GitHub, Inc.
\ No newline at end of file
diff --git a/WebAppDEMO/WebApp/Views/Cars/Edit.cshtml b/WebAppDEMO/WebApp/Views/Cars/Edit.cshtml
index 8caebe8..64f5fde 100644
--- a/WebAppDEMO/WebApp/Views/Cars/Edit.cshtml
+++ b/WebAppDEMO/WebApp/Views/Cars/Edit.cshtml
@@ -1,4 +1,4 @@
-ï»¿@model WebApp.Data.Models.Car
+ï»¿@model EditCarFormModel
 
 @{
     ViewData["Title"] = "Edit";
@@ -56,33 +56,23 @@
                     <input asp-for="VinNumber" class="form-control" placeholder="Ð Ð°Ð¼Ð° ÐÐ¾Ð¼ÐµÑ">
                     <span asp-validation-for="VinNumber" class="text-danger"></span>
                 </div>
+                
+
+                <span asp-validation-for="FuelTypes" class="text-danger"></span>
                 <div class="input-group form-group">
-                    <div class="input-group-prepend">
-                        <span class="input-group-text"></span>
-                    </div>
-                    <input asp-for="FuelType" class="form-control" placeholder="ÐÐ¸Ð´ ÐÐ¾ÑÐ¸Ð²Ð¾">
-                    <span asp-validation-for="FuelType" class="text-danger"></span>
+                <div class="input-group-prepend">
+                    <span class="input-group-text"></span>
+                </div>
+                <select asp-for="FuelTypeId" class="form-control">
+                    <option value="" disabled selected hidden>ÐÐ¸Ð´ ÐÐ¾ÑÐ¸Ð²Ð¾</option>
+                    @foreach (var item in Model.FuelTypes)
+                    {
+                        <option value="@item.Id">@item.Name</option>
+                    }
+                </select>
                 </div>
                 
-                
-                
-                
-                @*<div class="input-group form-group">
-                    <div class="input-group-prepend">
-                        <span class="input-group-text"></span>
-                    </div>
-                    <select asp-for="FuelTypeId" class="form-control" >
-                        <option value="" disabled selected hidden >ÐÐ¸Ð´ ÐÐ¾ÑÐ¸Ð²Ð¾</option>
-                        @foreach (var item in Model.FuelTypes)
-                        {
-                            <option value="@item.Id">@item.Name</option>
-                        }
-                    </select>
-                    <span asp-validation-for="FuelTypes" class="text-danger"></span>
-                </div>*@
-
-
-
+              
 
                 <div class="input-group form-group">
                     <div class="input-group-prepend">
diff --git a/WebAppDEMO/WebApp/WebApp.csproj b/WebAppDEMO/WebApp/WebApp.csproj
index 673a942..a67d326 100644
--- a/WebAppDEMO/WebApp/WebApp.csproj
+++ b/WebAppDEMO/WebApp/WebApp.csproj
@@ -11,8 +11,11 @@
     <PackageReference Include="Microsoft.AspNetCore.Identity.EntityFrameworkCore" Version="5.0.6" />
     <PackageReference Include="Microsoft.AspNetCore.Identity.UI" Version="5.0.6" />
     <PackageReference Include="Microsoft.AspNetCore.Mvc.Razor.RuntimeCompilation" Version="5.0.6" />
-    <PackageReference Include="Microsoft.EntityFrameworkCore.SqlServer" Version="5.0.6" />
-    <PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="5.0.6" />
+    <PackageReference Include="Microsoft.EntityFrameworkCore.SqlServer" Version="5.0.8" />
+    <PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="5.0.8">
+      <PrivateAssets>all</PrivateAssets>
+      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
+    </PackageReference>
     <PackageReference Include="Microsoft.VisualStudio.Web.CodeGeneration.Design" Version="5.0.2" />
   </ItemGroup>
 
-- 
2.31.1.windows.1

